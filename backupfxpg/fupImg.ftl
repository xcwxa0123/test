<script>
	<#include "mergePic.js">
</script>
<div class="ab-wrapper">
    <div class="ab-content">
       <div class='trade-indicator'>
       		<#if info??>
       		<p class='ab-info'><i class='icon icon-spin icon-spinner icon-2x'></i>${info!"后台处理中，请稍候..."}</p>
       		<#else>
       		<p class='ab-info'><i class='icon icon-spin icon-spinner icon-2x'></i>上传影像中，请稍候...</p>
       		</#if>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
       </div>
    </div>
    
    <div class='ab-controller-bar'>
    </div>
</div>

<script>  
    const customName = `${customName!""}`;
	const idCardNo = `${idCardNo!""}`;
	const date = `${date!""}`;
	const time = `${time!""}`;
   
    let imgPath1 = "/file\\C:\\Program Files\\CEB\\stm\\signature\\answer.jpg";
    let merge = new mergePic();

       merge.getImgInfo(imgPath1).then(p1 =>{
        let img1_width = p1.naturalWidth;
        let img1_height = p1.naturalHeight;
        let baseCode1 = p1.baseCode;
			let param = new Array();
	        {
                let p = {}
                p.x = 0;
                p.y = img1_height + 20;
                p.font = "20px 微软雅黑";
                p.content = "客户签名：线下纸质签字留存";
                param.push(p);
            }
            {
                let p = {};
                p.x = 0;
                p.y = img1_height + 20 * 2 + 5;
                p.font = "20px 微软雅黑";
                p.content = "客户姓名：";
                param.push(p);
            }
            {
                let p = {};
                p.x = 100;
                p.y = img1_height + 20 * 2 + 5;
                p.font = "20px 微软雅黑";
                p.content = customName;
                param.push(p);
            }
            {
                let p = {};
                p.x = 0;
                p.y = img1_height + 20 * 3 + 5;
                p.font = "20px 微软雅黑";
                p.content = "证件号码：";
                param.push(p);
            }
            {
                let p = {};
                p.x = 100;
                p.y = img1_height + 20 * 3 + 5;
                p.font = "20px 微软雅黑";
                p.content = idCardNo;
                param.push(p);
            }
            {
                let p = {};
                p.x = 0;
                p.y = img1_height + 20 * 4 + 10;
                p.font = "20px 微软雅黑";
                p.content = "交易日期：";
                param.push(p);
            }
            {
                let p = {};
                p.x = 100;
                p.y = img1_height + 20 * 4 + 10;
                p.font = "20px 微软雅黑";
                p.content = date;
                param.push(p);
            }
            {
                let p = {};
                p.x = 0;
                p.y = img1_height + 20 * 5 + 15;
                p.font = "20px 微软雅黑";
                p.content = "交易时间：";
                param.push(p);
            }
            {
                let p = {};
                p.x = 100;
                p.y = img1_height + 20 * 5 + 15;
                p.font = "20px 微软雅黑";
                p.content = time;
                param.push(p);
            }
            
           
        	  let image1 = new Image();
              image1.src = baseCode1;
              image1.onload =  function(){
                let canvas = $("<canvas></canvas>")[0];
                canvas.height = img1_height+(20*7);
        	    canvas.width =  img1_width;
			    ctx = canvas.getContext('2d');
        	    ctx.fillStyle = "#ffffff";
        	    ctx.fillRect(0, 0, canvas.width, canvas.height);
              	ctx.drawImage(image1, 0, 0,image1.width,image1.height);
              	 for (let i = 0; i < param.length; i++) {
                  let p = param[i];
                  ctx.font = p.font;
                  console.log(" content:" + p.content + ",x:" + p.x + ",y:" + p.y)
                  ctx.fillStyle="black";
                ctx.fillText(p.content, p.x, p.y);
               
                }
              	
              	let baseCode = canvas.toDataURL("image/jpeg"); 
              	 base64ToImg(baseCode);
            }
			
     
            
     });
             
     
      let base64ToImg = function(basePath){
        const filePath = "C:\\Program Files\\CEB\\stm\\signature\\lcpg.jpg";
        domain.require("fs").then(cs =>{
            cs.baseImg(filePath,basePath).then(result => {
            	if(result && "true" == result){
					domain.callMethodPromise("upImg");					
            	}else{
					failHandler("base64转图片失败");
            	}
            });
        })
    }
    
    let failHandler = function(info){
    	domain.callMethodPromise("failHandler",info)
    }
    
     
   
	
</script>


